#!/usr/bin/env ruby

this_file = File.symlink?(__FILE__) ? File.readlink(__FILE__) : __FILE__
dir = File.expand_path(File.join(this_file, "..", "..", "lib"))
$:.unshift dir unless $:.include?(dir)

argv = ARGV.dup

require "fundler"

# If ruby gems has loaded, reload the bin with rubygems disabled.
# This feels like a hack.
begin
  Gem
  puts Fundler.command_without_rubygems this_file, argv
rescue e => NameError
  p e.message
end

require "fundler/setup"

command = argv.shift

if command == "exec"
  script = argv[0]
  args   = argv[1..argv.length]

  FUNDLER.exec script, args
end

if command == "install"
  FUNDLER.gems.each do |gem|
    puts "Installing #{gem.name} (#{gem.version})"
    gem.install unless gem.installed?
  end
end
